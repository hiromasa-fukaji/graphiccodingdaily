<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Particle 'A' - IBM Plex Mono</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000000;
    }
    canvas {
      display: block;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
</head>
<body>
  <script>
    let font;
    let particles = [];
    const letter = 'A';
    let fontError = false;

    function preload() {
      // Load IBM Plex Mono font from Google Fonts
      font = loadFont(
        'https://fonts.gstatic.com/s/ibmplexmono/v20/-F6qfjptAgt5VM-kVkqdyU8n3pQP8lc.ttf',
        () => {
          console.log('Font loaded successfully: IBM Plex Mono');
        },
        () => {
          console.error('Font loading failed. Check internet connection or firewall.');
          fontError = true;
        }
      );
    }

    function setup() {
      createCanvas(windowWidth, windowHeight);
      
      if (fontError) {
        // Display an error message on the canvas if the font fails to load
        background(0);
        textAlign(CENTER, CENTER);
        fill(255, 0, 0);
        textSize(20);
        text('Font loading failed. Cannot create particle effect.', width / 2, height / 2);
        noLoop();
        return;
      }
      
      textFont(font);
      const fontSize = min(width * 0.8, height * 0.8);
      textSize(fontSize);

      const points = font.textToPoints(letter, 0, 0, fontSize, {
        sampleFactor: 0.15, // Adjust for particle density
        simplifyThreshold: 0
      });

      if (points.length === 0) {
          console.error('Font loaded, but no points were generated for the letter.');
          fontError = true;
          noLoop();
          return;
      }

      // Center the letter form
      const bounds = font.textBounds(letter, 0, 0, fontSize);
      const offsetX = width / 2 - bounds.w / 2;
      const offsetY = height / 2 + bounds.h / 2;

      // Create a particle for each point
      points.forEach(pt => {
        particles.push(new Particle(pt.x + offsetX, pt.y + offsetY));
      });
    }

    function draw() {
      if (fontError) return;
      background(0, 50); // Black background with trail effect

      for (const p of particles) {
        p.behaviors();
        p.update();
        p.show();
      }
    }

    function windowResized() {
      if (!fontError) {
        window.location.reload();
      }
    }

    class Particle {
      constructor(x, y) {
        this.target = createVector(x, y);
        this.pos = createVector(random(width), random(height));
        this.vel = p5.Vector.random2D();
        this.acc = createVector();
        this.r = 4;
        this.maxSpeed = 10;
        this.maxForce = 1;
        this.color = color(255, 150, 0, 200);
      }
      behaviors() {
        const arrive = this.arrive(this.target);
        this.acc.add(arrive);

        const mouse = createVector(mouseX, mouseY);
        const flee = this.flee(mouse);
        this.acc.add(flee);
      }
      update() {
        this.pos.add(this.vel);
        this.vel.add(this.acc);
        this.vel.limit(this.maxSpeed);
        this.acc.mult(0);
      }
      show() {
        noStroke();
        fill(this.color);
        ellipse(this.pos.x, this.pos.y, this.r * 2);
      }
      arrive(target) {
        const desired = p5.Vector.sub(target, this.pos);
        const d = desired.mag();
        let speed = this.maxSpeed;
        if (d < 100) {
          speed = map(d, 0, 100, 0, this.maxSpeed);
        }
        desired.setMag(speed);
        const steer = p5.Vector.sub(desired, this.vel);
        steer.limit(this.maxForce);
        return steer;
      }
      flee(target) {
        const desired = p5.Vector.sub(target, this.pos);
        const d = desired.mag();
        if (d < 80) {
          desired.setMag(this.maxSpeed);
          desired.mult(-1);
          const steer = p5.Vector.sub(desired, this.vel);
          steer.limit(this.maxForce);
          return steer;
        }
        return createVector(0, 0);
      }
    }
  </script>
</body>
</html>
